<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - IoT Water Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --sidebar: #16213e;
      --card-bg: rgba(255, 255, 255, 0.95);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: var(--sidebar);
      color: white;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .logo i {
      font-size: 24px;
      color: var(--success);
      margin-right: 10px;
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .nav-links {
      list-style: none;
      padding: 0 10px;
    }

    .nav-links li {
      margin-bottom: 5px;
    }

    .nav-links a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover, .nav-links a.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-links i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .header h2 {
      color: var(--dark);
      font-size: 1.8rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #d1145a;
      transform: translateY(-2px);
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 24px;
    }

    .stat-icon.users {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary);
    }

    .stat-icon.residence {
      background: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }

    .stat-icon.employee {
      background: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }

    .stat-icon.admin {
      background: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }

    .stat-info h3 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .stat-info p {
      color: #666;
      font-size: 0.9rem;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn-add {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
    }

    .btn-add:hover {
      background: #3050d0;
      transform: translateY(-2px);
    }

    .filter-bar {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-bar select, .filter-bar input {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 0.9rem;
    }

    .filter-bar input {
      width: 250px;
    }

    /* User List */
    .user-list-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .user-list-header h3 {
      color: var(--dark);
      font-size: 1.4rem;
    }

    .user-count {
      background: var(--primary);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .user-list {
      display: grid;
      gap: 15px;
    }

    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary);
    }

    .user-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-info-main {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .user-role {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .role-admin {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }

    .role-employee {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning);
    }

    .role-residence {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success);
    }

    .user-details {
      font-size: 0.85rem;
      color: #666;
      margin-top: 8px;
    }

    .user-details div {
      margin-bottom: 3px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .edit {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .edit:hover {
      background: var(--primary);
      color: white;
    }

    .delete {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }

    .delete:hover {
      background: var(--danger);
      color: white;
    }

    .reset {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning);
    }

    .reset:hover {
      background: var(--warning);
      color: white;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: modalAppear 0.3s ease;
    }

    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      color: var(--dark);
      font-size: 1.4rem;
    }

    .close {
      font-size: 24px;
      cursor: pointer;
      color: #999;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--danger);
    }

    .modal-body {
      padding: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: var(--primary);
      outline: none;
    }

    .residence-paths {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 3px solid var(--success);
    }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #3050d0;
    }

    .btn-secondary {
      background: #f1f1f1;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e1e1e1;
    }

    .success-message {
      padding: 12px 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
      font-weight: 600;
      display: none;
    }

    .success {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success);
      border: 1px solid rgba(76, 201, 240, 0.3);
    }

    .error {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger);
      border: 1px solid rgba(247, 37, 133, 0.3);
    }

    /* Loading Spinner */
    .loading {
      display: none;
      text-align: center;
      margin: 10px 0;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 992px) {
      .dashboard-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        padding: 15px 0;
      }
      
      .nav-links {
        display: flex;
        overflow-x: auto;
        padding: 0 10px;
      }
      
      .nav-links li {
        flex: 0 0 auto;
        margin-bottom: 0;
        margin-right: 10px;
      }
    }

    @media (max-width: 768px) {
      .action-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filter-bar {
        width: 100%;
      }
      
      .filter-bar input {
        width: 100%;
      }
      
      .user-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .actions {
        margin-top: 15px;
        width: 100%;
        justify-content: flex-end;
      }
    }
    /* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: modalAppear 0.3s ease;
    position: relative;
}

@keyframes modalAppear {
    from { 
        opacity: 0; 
        transform: scale(0.9) translateY(-20px); 
    }
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
}

.modal-content .close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    background: none;
    border: none;
    transition: color 0.3s ease;
    z-index: 10;
}

.modal-content .close:hover {
    color: #f72585;
}

.modal-content h3 {
    color: #1a1a2e;
    font-size: 1.4rem;
    margin: 0;
    padding: 20px 25px 15px;
    border-bottom: 1px solid #eee;
}

/* Form Styles */
#userForm {
    padding: 20px 25px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

#userForm input,
#userForm select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

#userForm input:focus,
#userForm select:focus {
    border-color: #4361ee;
    outline: none;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

#userForm input::placeholder {
    color: #999;
}

#residencePaths {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
    border-left: 3px solid #4cc9f0;
}

#residencePaths input {
    margin-bottom: 10px;
}

#residencePaths input:last-child {
    margin-bottom: 0;
}

#userForm button[type="submit"] {
    background: #4361ee;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    margin-top: 10px;
}

#userForm button[type="submit"]:hover {
    background: #3050d0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

#userForm button[type="submit"]:active {
    transform: translateY(0);
}

/* Success Message */
.success {
    padding: 12px 15px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: center;
    font-weight: 600;
    background: rgba(76, 201, 240, 0.1);
    color: #4cc9f0;
    border: 1px solid rgba(76, 201, 240, 0.3);
    display: none;
}

/* Modal Footer */
.modal-footer {
    padding: 15px 25px 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f9f9f9;
    border-radius: 0 0 12px 12px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.95rem;
}

.btn-primary {
    background: #4361ee;
    color: white;
}

.btn-primary:hover {
    background: #3050d0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.btn-secondary {
    background: #f1f1f1;
    color: #333;
}

.btn-secondary:hover {
    background: #e1e1e1;
    transform: translateY(-2px);
}

/* Responsive Design */
@media (max-width: 480px) {
    .modal-content {
        width: 95%;
        margin: 20px;
    }
    
    #userForm {
        padding: 15px 20px;
    }
    
    .modal-footer {
        padding: 15px 20px;
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}

/* Form Validation Styles */
#userForm input:invalid:not(:focus):not(:placeholder-shown) {
    border-color: #f72585;
    background: rgba(247, 37, 133, 0.05);
}

#userForm input:valid:not(:focus):not(:placeholder-shown) {
    border-color: #4cc9f0;
    background: rgba(76, 201, 240, 0.05);
}

/* Loading State */
#userForm button[type="submit"]:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

#userForm button[type="submit"]:disabled:hover {
    background: #ccc;
    transform: none;
    box-shadow: none;
}
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <i class="fas fa-water"></i>
        <h1>Lgcts Admin</h1>
      </div>
      <ul class="nav-links">
        <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="bill.html"><i class="fas fa-file-invoice-dollar"></i> Bill Rates</a></li>
        <li><a href="message_contact.html"><i class="fas fa-envelope"></i> Contact Messages</a></li>
        <li><a href="#"><i class="fas fa-chart-bar"></i> Analytics</a></li>
        <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h2>Admin Dashboard</h2>
        <div class="user-info">
          <div class="user-avatar">A</div>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Log Out
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 id="totalUsers">0</h3>
            <p>Total Users</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon residence">
            <i class="fas fa-home"></i>
          </div>
          <div class="stat-info">
            <h3 id="residenceUsers">0</h3>
            <p>Residences</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon employee">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-info">
            <h3 id="employeeUsers">0</h3>
            <p>Employees</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon admin">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="stat-info">
            <h3 id="adminUsers">0</h3>
            <p>Admins</p>
          </div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <button class="btn-add" onclick="openModal()">
          <i class="fas fa-plus"></i> Add User
        </button>
        <div class="filter-bar">
          <select id="roleFilter">
            <option value="all">All Roles</option>
            <option value="residence">Residence</option>
            <option value="employee">Employee</option>
            <option value="admin">Admin</option>
          </select>
          <input type="text" id="searchInput" placeholder="Search by username..."/>
        </div>
      </div>

      <!-- User List -->
      <div class="user-list-container">
        <div class="user-list-header">
          <h3>User Management</h3>
          <div class="user-count" id="userCount">0 Users</div>
        </div>
        <div class="user-list" id="userList"></div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div class="modal" id="userModal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">Add User</h3>
      <form id="userForm">
        <input type="text" id="username" placeholder="Username" required/>
        <input type="password" id="password" placeholder="Password" required/>
        <select id="role" required>
          <option value="">Select Role</option>
          <option value="admin">Admin</option>
          <option value="employee">Employee</option>
          <option value="residence">Residence</option>
        </select>
        <div id="residencePaths" style="display: none; margin-top:10px;">
          <input type="text" id="customID" placeholder="Custom Residence ID (optional)" /><br><br>
          <input type="text" id="sensorRoot" placeholder="Sensor Root (e.g., sensors1)" />
        </div>
        <button type="submit">Save</button>
      </form>
      <div class="success" id="messageBox"></div>
    </div>
  </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Save User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
   const firebaseConfig = {
      databaseURL: "https://waterbase-b1393-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let editUserId = null, usersData = {};

    // Show/hide sensor root input for residence role
    document.getElementById("role").addEventListener("change", e => {
      document.getElementById("residencePaths").style.display = e.target.value === "residence" ? "block" : "none";
    });

    // Modal functions
    function openModal(edit = false) {
      document.getElementById("userModal").style.display = "flex";
      document.getElementById("modalTitle").innerText = edit ? "Edit User" : "Add User";
    }
    function closeModal() {
      document.getElementById("userModal").style.display = "none";
      document.getElementById("userForm").reset();
      document.getElementById("residencePaths").style.display = "none";
      editUserId = null;
    }

    // Handle save
    document.getElementById("userForm").addEventListener("submit", e => {
      e.preventDefault();
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      const r = document.getElementById("role").value; 

      const root = document.getElementById("sensorRoot").value.trim();
      const customID = document.getElementById("customID").value.trim();

      if (!u || !p || !r) return showMsg("‚ùå All fields are required");

      // Reference for new or existing user
      let userRef;
      if(editUserId) {
        userRef = db.ref("users/" + editUserId);
      } else {
        if (customID) {
          userRef = db.ref("users/" + customID);
          editUserId = customID;
        } else {
          userRef = db.ref("users").push();
          editUserId = userRef.key;
        }
      }

      // Base user data
      let userData = { username: u, password: p, role: r };

      // Residence gets sensor paths
      if (r === "residence") {
        if (!root) return showMsg("‚ùå Sensor root is required");

        const sensorPath = `${root}/${editUserId}/water_timer_counter/value`;
        const logPath = `${root}/${editUserId}/water_timer_counter/logs`;
        const switchPath = `${root}/${editUserId}/control_switch/value`;
        const alertPath = `${root}/${editUserId}/water_alerts`;

        userData = { ...userData, sensorRoot: root, sensorPath, logPath, switchPath, alertPath };
      }

      // Save user
      userRef.set(userData)
        .then(() => {
          showMsg("‚úÖ Saved successfully");

          // If residence, also create initial Firebase sensor structure
          if (r === "residence" && root) {
            const devicePath = `${root}/${editUserId}`;
            db.ref(devicePath).once("value").then(snap => {
              if (!snap.exists()) {
                const ts = Date.now();
                const sensorData = {
                  control_switch: { value: true },
                  water_alerts: {
                    [`alert_${ts}`]: {
                      message: "Welcome! We're so glad to have you here.",
                      pulses: 0,
                      timestamp: ts
                    }
                  },
                  water_timer_counter: {
                    value: 0,
                    logs: {
                      exampleLog1: { pulses: 5, timestamp: ts },
                      exampleLog2: { pulses: 8, timestamp: ts + 1000 }
                    }
                  }
                };
                db.ref(devicePath).set(sensorData)
                  .catch(err => console.error("Failed set sensorData:", err));
              }
            });
          }

          closeModal();
          setTimeout(loadUsers, 350); // reload users
        })
        .catch(err => {
          console.error("Save failed:", err);
          showMsg("‚ùå Failed to save user", true);
        });
    });

    // Utility message
    function showMsg(msg) {
      const box = document.getElementById("messageBox");
      box.innerText = msg;
      setTimeout(() => { box.innerText = ""; }, 3000);
    }

     // Load all users
    function loadUsers() {
      db.ref("users").once("value").then(snap => {
        usersData = snap.val() || {};
        updateStats();
        renderUsers();
      }).catch(error => {
        console.error("Error loading users:", error);
        showMsg("‚ùå Failed to load users", true);
      });
    }

   // Render users
    function renderUsers() {
      const userList = document.getElementById("userList");
      const rf = document.getElementById("roleFilter").value;
      const sw = document.getElementById("searchInput").value.toLowerCase();
      
      userList.innerHTML = "";
      let found = 0;
      
      for (const id in usersData) {
        const u = usersData[id];
        if ((rf === "all" || u.role === rf) && u.username.toLowerCase().includes(sw)) {
          found++;
          
          const roleClass = `role-${u.role}`;
          const info = u.role === "residence" ? `
            <div class="user-details">
              <div><i class="fas fa-satellite-dish"></i> Root: ${u.sensorRoot || 'N/A'}</div>
              <div><i class="fas fa-toggle-on"></i> Switch: ${u.switchPath || 'N/A'}</div>
              <div><i class="fas fa-bell"></i> Alerts: ${u.alertPath || 'N/A'}</div>
              <div><i class="fas fa-history"></i> Logs: ${u.logPath || 'N/A'}</div>
              <div><i class="fas fa-money-bill-wave"></i> Total Bill: ‚Ç±${u.total_bill || 0}</div>
            </div>` : "";
            
          userList.innerHTML += `
            <div class="user-item">
              <div class="user-info-main">
                <div class="user-name">${u.username}</div>
                <div class="user-role ${roleClass}">${u.role}</div>
                <div style="font-size: 0.85rem; color: #888;">Password: ${u.password}</div>
                ${info}
              </div>
              <div class="actions">
                <button class="edit" onclick="editUser('${id}')">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete" onclick="deleteUser('${id}')">
                  <i class="fas fa-trash"></i> Delete
                </button>
                ${u.role === "residence" ? `
                <button class="reset" onclick="resetBill('${id}')">
                  <i class="fas fa-sync-alt"></i> Reset Bill
                </button>` : ""}
              </div>
            </div>`;
        }
      }
      
      document.getElementById("userCount").textContent = `${found} Users`;
      
      if (!found) {
        userList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #888;">
            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <p>No users found matching your criteria.</p>
          </div>`;
      }
    }

    // Update statistics
    function updateStats() {
      let total = 0, residence = 0, employee = 0, admin = 0;
      
      for (const id in usersData) {
        total++;
        const role = usersData[id].role;
        if (role === "residence") residence++;
        else if (role === "employee") employee++;
        else if (role === "admin") admin++;
      }
      
      document.getElementById("totalUsers").textContent = total;
      document.getElementById("residenceUsers").textContent = residence;
      document.getElementById("employeeUsers").textContent = employee;
      document.getElementById("adminUsers").textContent = admin;
    }

    // Reset bill
    function resetBill(userId) {
      if (confirm(`Reset Total Bill for user ${userId}?`)) {
        db.ref("users/" + userId + "/total_bill").set(0)
          .then(() => {
            showMsg(`üîÑ Total Bill reset for ${userId}`);
            loadUsers();
          });
      }
    }

    // Edit user
    function editUser(id) {
      const u = usersData[id];
      if (!u) return showMsg("‚ùå User not found", true);
      openModal(true);
      document.getElementById("username").value = u.username;
      document.getElementById("password").value = u.password;
      document.getElementById("role").value = u.role;
      document.getElementById("residencePaths").style.display = u.role === "residence" ? "block" : "none";
      document.getElementById("customID").value = id;
      if (u.sensorRoot) document.getElementById("sensorRoot").value = u.sensorRoot;
      editUserId = id;
    }

    // Delete user
    function deleteUser(id) {
      if (confirm("Delete this user?")) {
        db.ref("users/" + id).remove().then(() => {
          showMsg("üóëÔ∏è Deleted");
          loadUsers();
        });
      }
    }

    // Logout
    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    // Event listeners
    document.getElementById("roleFilter").addEventListener("change", renderUsers);
    document.getElementById("searchInput").addEventListener("input", renderUsers);

    loadUsers();
  </script>
</body>
</html>
