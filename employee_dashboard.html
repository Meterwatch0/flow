<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Employee Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --success: #4cc9f0;
  --danger: #f72585;
  --warning: #f8961e;
  --light: #f8f9fa;
  --dark: #212529;
  --gray: #6c757d;
  --light-gray: #e9ecef;
  --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
  color: var(--dark);
  min-height: 100vh;
  padding-bottom: 20px;
}

/* Navbar */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 30px;
  background: white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 1.5rem;
  color: var(--primary);
}

.logo i {
  font-size: 1.8rem;
}

.add-btn, .status-btn, .logout-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.add-btn {
  background: var(--primary);
  color: white;
}

.add-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--hover-shadow);
}

.status-btn {
  background: var(--light-gray);
  color: var(--dark);
  text-decoration: none;
}

.status-btn:hover {
  background: var(--gray);
  color: white;
}

.logout-btn {
  background: var(--danger);
  color: white;
}

.logout-btn:hover {
  background: #e1156d;
  transform: translateY(-2px);
}

.navbar-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Notification */
#notifWrapper {
  position: relative;
  cursor: pointer;
  padding: 10px 15px;
  border-radius: 8px;
  background: var(--light);
  transition: var(--transition);
}

#notifWrapper:hover {
  background: var(--light-gray);
}

#notifCount {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: bold;
}

#notifPopup {
  display: none;
  position: absolute;
  top: 60px;
  right: 0;
  width: 350px;
  background: white;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  z-index: 101;
  max-height: 400px;
  overflow-y: auto;
}

#notifPopup h4 {
  padding: 15px;
  border-bottom: 1px solid var(--light-gray);
  margin: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#notifList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#notifList li {
  padding: 12px 15px;
  border-bottom: 1px solid var(--light-gray);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: var(--transition);
}

#notifList li:hover {
  background: var(--light);
}

#notifList li button {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 1.2rem;
  padding: 0 5px;
}

/* Top Notification Banner */
.top-notif {
  display: none;
  background: var(--primary);
  color: white;
  text-align: center;
  padding: 12px;
  font-weight: 500;
  position: sticky;
  top: 70px;
  z-index: 99;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Header */
.header {
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  color: var(--dark);
  background: linear-gradient(to right, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header p {
  color: var(--gray);
  font-size: 1.1rem;
  max-width: 600px;
  margin: 0 auto;
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
  padding: 0 30px;
  margin-top: 20px;
}

/* Meter Card */
.meter-card {
  background: white;
  border-radius: 16px;
  padding: 25px;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.meter-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--hover-shadow);
}

.meter-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
}

.circle-meter {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  background: conic-gradient(var(--primary) 0%, var(--light-gray) 0%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  position: relative;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.circle-meter::before {
  content: '';
  position: absolute;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: white;
}

.value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary);
  z-index: 1;
}

.unit {
  font-size: 0.9rem;
  color: var(--gray);
  z-index: 1;
}

.username {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 5px;
  color: var(--dark);
}

.role {
  color: var(--gray);
  margin-bottom: 20px;
  padding: 4px 12px;
  background: var(--light);
  border-radius: 20px;
  font-size: 0.9rem;
}

.card-actions {
  display: flex;
  gap: 10px;
  width: 100%;
}

.notif-btn, .chat-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.notif-btn {
  background: var(--warning);
  color: white;
}

.notif-btn:hover {
  background: #e08715;
}

.chat-btn {
  background: var(--success);
  color: white;
}

.chat-btn:hover {
  background: #3ab3d6;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.modal-content h3 {
  padding: 20px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  color: white;
  margin: 0;
  font-size: 1.5rem;
}

.modal-content form {
  padding: 25px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.modal-content input {
  padding: 14px;
  border: 1px solid var(--light-gray);
  border-radius: 8px;
  font-size: 1rem;
  transition: var(--transition);
}

.modal-content input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

.modal-content button {
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.modal-content button[type="submit"] {
  background: var(--primary);
  color: white;
}

.modal-content button[type="submit"]:hover {
  background: var(--primary-dark);
}

.close-btn {
  background: var(--light-gray);
  color: var(--dark);
}

.close-btn:hover {
  background: var(--gray);
  color: white;
}

/* Notification Popup */
.notif-popup {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background: white;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  padding: 20px;
  z-index: 10;
  margin-top: 10px;
}

.notif-popup textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--light-gray);
  border-radius: 8px;
  resize: vertical;
  min-height: 80px;
  margin-bottom: 10px;
  font-family: inherit;
}

.notif-popup button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.notif-popup button:first-of-type {
  background: var(--primary);
  color: white;
  margin-right: 10px;
}

.notif-popup button:first-of-type:hover {
  background: var(--primary-dark);
}

.closeN {
  background: var(--light-gray);
  color: var(--dark);
}

.closeN:hover {
  background: var(--gray);
  color: white;
}

/* Chat Popup */
.chat-popup {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  flex-direction: column;
  overflow: hidden;
}

.chat-header {
  padding: 15px 20px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header span {
  font-weight: 600;
  font-size: 1.1rem;
}

#closeChat {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

#closeChat:hover {
  background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.chat-messages div {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 0.95rem;
  line-height: 1.4;
  position: relative;
}

.sent {
  align-self: flex-end;
  background: var(--primary);
  color: white;
  border-bottom-right-radius: 5px;
}

.received {
  align-self: flex-start;
  background: var(--light-gray);
  color: var(--dark);
  border-bottom-left-radius: 5px;
}

.chat-form {
  display: flex;
  padding: 15px;
  border-top: 1px solid var(--light-gray);
  gap: 10px;
}

.chat-form input {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid var(--light-gray);
  border-radius: 25px;
  outline: none;
  transition: var(--transition);
}

.chat-form input:focus {
  border-color: var(--primary);
}

.chat-form button {
  padding: 12px 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  transition: var(--transition);
  font-weight: 600;
}

.chat-form button:hover {
  background: var(--primary-dark);
}

/* Responsive */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 15px;
    padding: 15px;
  }
  
  .navbar-left, .navbar-right {
    width: 100%;
    justify-content: center;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    padding: 0 15px;
  }
  
  .chat-popup {
    width: calc(100% - 40px);
    height: 70vh;
  }
  
  .header h1 {
    font-size: 2rem;
  }
}

/* Animation for meter cards */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.meter-card {
  animation: fadeIn 0.5s ease-out;
}
</style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <div class="navbar-left">
    <div class="logo">
      <i class="fas fa-tint"></i>
      <span>AquaTrack</span>
    </div>
    <button class="add-btn" onclick="openModal()">
      <i class="fas fa-plus"></i> Add Residence
    </button>
    <a href="status.html" class="status-btn">
      <i class="fas fa-users"></i> Users Status
    </a>
  </div>
  
  <div class="navbar-right">
    <div id="notifWrapper">
      <i class="fas fa-bell"></i>
      <span id="notifCount">0</span>
    </div>
    
    <!-- Notification Popup -->
    <div id="notifPopup">
      <h4>Notifications <span id="notifCountTitle">(0)</span></h4>
      <ul id="notifList"></ul>
    </div>
    
    <button class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- Notification Banner -->
<div class="top-notif" id="topNotif"></div>

<!-- Header -->
<div class="header">
  <h1>Welcome, Employee</h1>
  <p>Monitor water usage, communicate with residents, and manage accounts</p>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid" id="usersDiv"></div>

<!-- Modal -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Add Residence Account</h3>
    <form id="residenceForm">
      <input type="text" id="resUsername" placeholder="Username" required />
      <input type="password" id="resPassword" placeholder="Password" required />
      <input type="text" id="sensorRoot" placeholder="Sensor Root (e.g., sensorsX)" required />
      <div style="display: flex; gap: 10px;">
        <button type="submit">Add Residence</button>
        <button type="button" class="close-btn" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Chat Popup -->
<div id="chatPopup" class="chat-popup">
  <div class="chat-header">
    <span id="chatWith">Chat</span>
    <button id="closeChat">×</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <form id="chatForm" class="chat-form">
    <input type="text" id="chatInput" placeholder="Type your message..." required />
    <button type="submit">Send</button>
  </form>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ========== ORIGINAL JAVASCRIPT CODE ==========
const app = firebase.initializeApp({
  databaseURL: "https://waterbase-b1393-default-rtdb.asia-southeast1.firebasedatabase.app/"
});
const db = firebase.database(app);

// Modal
function openModal() { document.getElementById("addModal").style.display = "flex"; }
function closeModal() { document.getElementById("addModal").style.display = "none"; }

// Add Residence
document.getElementById("residenceForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const username = document.getElementById("resUsername").value.trim();
  const password = document.getElementById("resPassword").value.trim();
  const root = document.getElementById("sensorRoot").value.trim();
  if (!username || !password || !root) return alert("All fields are required");

  const newUser = { username, password, role: "residence", sensorRoot: root };
  try {
    await db.ref("users").push(newUser);
    alert("Residence account added!");
    this.reset();
    closeModal();
    loadAllUserMeters();
  } catch (err) {
    alert("Error: " + err.message);
  }
});

// Chat state
const username = "Employee";
let activeChatId = null;
let chatRef = null;

const chatPopup = document.getElementById("chatPopup");
const closeChat = document.getElementById("closeChat");
const chatMessages = document.getElementById("chatMessages");
const chatWith = document.getElementById("chatWith");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");
const topNotif = document.getElementById("topNotif");

closeChat.onclick = () => { chatPopup.style.display = "none"; if(chatRef) chatRef.off(); };

chatForm.addEventListener("submit", e => {
  e.preventDefault();
  if (!activeChatId) return;
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatRef.push({ sender: username, text: msg, timestamp: Date.now() });
  chatInput.value = "";
});

async function loadAllUserMeters() {
  const container = document.getElementById("usersDiv");
  container.innerHTML = "";
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val() || {};

  for (const uid in users) {
    const user = users[uid];
    let sensorPath = null;

    if (user.role === "residence" && user.sensorRoot) {
      sensorPath = `${user.sensorRoot}/${uid}/water_timer_counter/value`;
    } else if (user.sensorPath) {
      sensorPath = user.sensorPath;
    }

    if (!sensorPath) continue;

    const card = document.createElement("div");
    card.className = "meter-card";
    card.innerHTML = `
      <div class="circle-meter">
        <div class="value">...</div>
        <div class="unit">cubicmeter</div>
        <div class="unit">liters</div>
      </div>
      <div class="username">${user.username}</div>
      <div class="role">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</div>
      <div class="card-actions">
        <button class="notif-btn" onclick="toggleNotif('${uid}')">
          <i class="fas fa-bell"></i> Notify
        </button>
        <button class="chat-btn" onclick="openChat('${user.username}')">
          <i class="fas fa-comment"></i> Chat
        </button>
      </div>
      <div class="notif-popup" id="notif-${uid}">
        <textarea placeholder="Enter notification message..."></textarea>
        <div>
          <button onclick="sendNotif('${uid}')">Send</button>
          <button class="closeN" onclick="toggleNotif('${uid}')">Cancel</button>
        </div>
      </div>
    `;

    container.appendChild(card);

    const valueEl = card.querySelector(".value");
    const circleMeter = card.querySelector(".circle-meter");
    
    db.ref(sensorPath).on("value", (snap) => {
      const val = snap.val();
      const displayValue = val !== null ? val : "0";
      valueEl.textContent = displayValue;
      
      // Update the circle meter visualization
      if (val !== null && !isNaN(val)) {
        const percentage = Math.min(val / 1000 * 100, 100); // Assuming 1000 is max
        circleMeter.style.background = `conic-gradient(var(--primary) ${percentage}%, var(--light-gray) ${percentage}%)`;
      }
    }, () => {
      valueEl.textContent = "N/A";
    });
  }

  if (container.innerHTML === "") {
    container.innerHTML = "<p style='grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gray);'>No users with meters found.</p>";
  }
}

function toggleNotif(uid) {
  const popup = document.getElementById(`notif-${uid}`);
  popup.style.display = popup.style.display === "block" ? "none" : "block";
}

function sendNotif(uid) {
  const popup = document.getElementById(`notif-${uid}`);
  const textarea = popup.querySelector("textarea");
  const message = textarea.value.trim();
  if (!message) return alert("Message is empty!");
  alert("Notification sent to " + uid + ": " + message);
  textarea.value = "";
  popup.style.display = "none";
}

// Chat
window.openChat = (resName) => {
  activeChatId = `${resName}_${username}`;
  chatWith.textContent = `Chat with ${resName}`;
  chatMessages.innerHTML = "";
  chatPopup.style.display = "flex";

  if(chatRef) chatRef.off();
  chatRef = db.ref("chats/" + activeChatId);
  chatRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = msg.sender === username ? "sent" : "received";
    div.textContent = msg.text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    if (msg.sender !== username) showTopNotif(`New message from ${msg.sender}: ${msg.text}`);
  });
};

function showTopNotif(message) {
  topNotif.textContent = message;
  topNotif.style.display = "block";
  setTimeout(() => { topNotif.style.display = "none"; }, 4000);
}

function logout() {
  localStorage.clear();
  sessionStorage.clear();
  window.location.replace("index.html");
}

loadAllUserMeters();

// ===== Notification System =====
const notifWrapper = document.getElementById("notifWrapper");
const notifCountEl = document.getElementById("notifCount");
const notifPopup = document.getElementById("notifPopup");
const notifList = document.getElementById("notifList");

let notifications = []; // array of objects { id, message }
let unreadCount = 0;
let notifPopupVisible = false;

// Simulate employee ID (in real use, get from auth/session)
const employeeId = "employee_123";

// Get hidden notifications for this employee from localStorage
function getHiddenNotifications() {
  const hidden = localStorage.getItem(`hiddenNotifs_${employeeId}`);
  return hidden ? JSON.parse(hidden) : [];
}

// Save hidden notifications list
function setHiddenNotifications(hiddenIds) {
  localStorage.setItem(`hiddenNotifs_${employeeId}`, JSON.stringify(hiddenIds));
}

// Hide notif count initially
notifCountEl.style.display = "none";
notifCountEl.textContent = "0";

// Render notifications
function renderNotifications() {
  notifList.innerHTML = ""; // clear list

  const hiddenIds = getHiddenNotifications();

  // Filter notifications not hidden for this employee
  const visibleNotifications = notifications.filter(notif => !hiddenIds.includes(notif.id));

  visibleNotifications.forEach(notif => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";
    li.style.padding = "4px 8px";
    li.style.borderBottom = "1px solid #eee";

    const span = document.createElement("span");
    span.textContent = notif.message;

    const delBtn = document.createElement("button");
    delBtn.textContent = "×";
    delBtn.style.background = "none";
    delBtn.style.border = "none";
    delBtn.style.color = "red";
    delBtn.style.fontWeight = "bold";
    delBtn.style.cursor = "pointer";
    delBtn.title = "Delete notification";

    delBtn.onclick = (e) => {
      e.stopPropagation();

      // Remove notification from array
      notifications = notifications.filter(n => n.id !== notif.id);

      // Add to hidden IDs to persist removal
      const hiddenIds = getHiddenNotifications();
      if (!hiddenIds.includes(notif.id)) {
        hiddenIds.push(notif.id);
        setHiddenNotifications(hiddenIds);
      }

      // Re-render the list
      renderNotifications();

      // Update unread count if popup hidden
      if (!notifPopupVisible) {
        unreadCount = Math.max(0, unreadCount - 1);
        notifCountEl.textContent = unreadCount;
        if (unreadCount === 0) {
          notifCountEl.style.display = "none";
        }
      }
    };

    li.appendChild(span);
    li.appendChild(delBtn);
    notifList.appendChild(li);
  });
}

// Add a new notification
function addNotification(message) {
  const id = Date.now().toString(); // unique ID
  const newNotif = { id, message };
  notifications.unshift(newNotif);

  // Update unread count only if popup hidden
  if (!notifPopupVisible) {
    unreadCount++;
    notifCountEl.textContent = unreadCount;
    notifCountEl.style.display = "inline-block";
  }

  renderNotifications();
}

// Toggle popup & reset counter
notifWrapper.onclick = () => {
  notifPopupVisible = !notifPopupVisible;
  notifPopup.style.display = notifPopupVisible ? "block" : "none";

  if (notifPopupVisible) {
    unreadCount = 0;
    notifCountEl.textContent = "0";
    notifCountEl.style.display = "none";
  }
};

// For testing, add some initial notifications
addNotification("Welcome to the system");
addNotification("You have 3 new messages");
addNotification("Server maintenance tonight");

// Call renderNotifications on page load to ensure state is correctly updated
renderNotifications();

////////////////////////////////////////////////////

// Listen for Firebase new chat messages to add notifications
const chatsRef = db.ref("chats");
chatsRef.on("child_added", (chatSnapshot) => {
  const chatId = chatSnapshot.key;
  const messagesRef = chatsRef.child(chatId);

  messagesRef.on("child_added", (msgSnap) => {
    const msg = msgSnap.val();
    if (msg.sender !== username) {
      const notifText = `New message from ${msg.sender}: ${msg.text}`;
      addNotification(notifText);
      fireSystemNotification(`New message from ${msg.sender}`, msg.text);
    }
  });
});

// Browser notification with service worker
async function fireSystemNotification(title, message) {
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      reg.showNotification(title, {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
        vibrate: [100, 50, 100],
        tag: "chat-message",
        renotify: true,
      });
    }
  }
}

// Request notification permission if not granted
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Register Service Worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
  .register("sw.js")
  .then(reg => {
    console.log("Service Worker registered", reg.scope);
  })
  .catch(err => {
    console.error("Service Worker registration failed", err);
  });
}
</script>
</body>
</html>
