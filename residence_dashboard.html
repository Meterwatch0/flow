<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Residence Water Flow Dashboard</title>
  <link rel="stylesheet" href="residence.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Styles -->
   <style>
    /* residence.css - Modern Water Flow Dashboard */

/* Base Styles */
/* Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --dark-bg: #0f0f1a;
  --darker-bg: #0a0a12;
  --card-bg: rgba(30, 30, 46, 0.6);
  --card-border: rgba(255, 255, 255, 0.1);
  --card-glow: rgba(102, 126, 234, 0.1);
  --text-primary: #ffffff;
  --text-secondary: #a0a0c0;
  --accent-green: #00d4aa;
  --accent-blue: #38bdf8;
  --accent-purple: #8b5cf6;
  --accent-red: #ff6b6b;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--dark-bg);
  min-height: 100vh;
  color: var(--text-primary);
  overflow-x: hidden;
  position: relative;
}

/* Animated Background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(0, 212, 170, 0.08) 0%, transparent 50%);
  z-index: -1;
  animation: backgroundShift 20s ease-in-out infinite;
}

@keyframes backgroundShift {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    opacity: 0.8;
  }
  50% { 
    transform: scale(1.1) rotate(180deg);
    opacity: 1;
  }
}

/* Glass Morphism Effect */
.glass {
  background: rgba(30, 30, 46, 0.4);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

/* Top Bar */
.top-bar {
  background: rgba(20, 20, 35, 0.8);
  backdrop-filter: blur(30px);
  padding: 1.2rem 2.5rem;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 1.2rem;
  box-shadow: 
    0 4px 20px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  position: relative;
  z-index: 100;
}

/* Glossy Buttons */
.logout-button, .notif-button {
  background: linear-gradient(135deg, var(--accent-red), #ff4757);
  color: white;
  border: none;
  padding: 0.8rem 1.8rem;
  border-radius: 50px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 
    0 6px 20px rgba(255, 107, 107, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;
  position: relative;
  overflow: hidden;
}

.logout-button::before, .notif-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s;
}

.logout-button:hover::before, .notif-button:hover::before {
  left: 100%;
}

.logout-button:hover, .notif-button:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 
    0 10px 25px rgba(255, 107, 107, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.notif-button {
  background: linear-gradient(135deg, var(--accent-green), #00b894);
  box-shadow: 
    0 6px 20px rgba(0, 212, 170, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.notif-count {
  background: linear-gradient(135deg, #ff4757, #ff3742);
  color: white;
  border-radius: 50%;
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
  min-width: 24px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 3px 10px rgba(255, 71, 87, 0.4);
  animation: pulse 2s infinite;
}

/* Welcome Message */
#welcomeMessage {
  text-align: center;
  color: var(--text-primary);
  font-size: 3rem;
  font-weight: 300;
  margin: 3rem 0;
  text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  position: relative;
  display: inline-block;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #fff, #a0a0c0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#welcomeMessage::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 25%;
  width: 50%;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent-purple), transparent);
  border-radius: 50%;
}

/* Dashboard Grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 2.5rem;
  padding: 2.5rem;
  max-width: 1400px;
  margin: 0 auto;
}

/* Enhanced Meter Circle */
.meter-circle {
  background: linear-gradient(135deg, var(--card-bg), rgba(40, 40, 60, 0.8));
  border-radius: 50%;
  width: 280px;
  height: 280px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.4),
    inset 0 5px 15px rgba(255, 255, 255, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
  border: 1px solid var(--card-border);
  backdrop-filter: blur(20px);
}

.meter-circle::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
  transform: rotate(45deg);
  transition: all 0.8s ease;
}

.meter-circle.flowing {
  animation: waterFlow 2s ease-in-out;
  background: linear-gradient(135deg, var(--accent-green), #00b894, var(--accent-green));
}

.meter-circle.liters-active {
  background: linear-gradient(135deg, var(--accent-green), #00b894, var(--accent-green));
  animation: litersPulse 1.5s ease-in-out;
  box-shadow: 
    0 0 40px rgba(0, 212, 170, 0.4),
    0 20px 40px rgba(0, 0, 0, 0.4),
    inset 0 5px 15px rgba(255, 255, 255, 0.1);
}

.meter-circle.liters-active::after {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background: linear-gradient(135deg, var(--accent-green), #00b894);
  border-radius: 50%;
  z-index: -1;
  animation: ripple 2s ease-out infinite;
  opacity: 0.3;
}

@keyframes waterFlow {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    background: linear-gradient(135deg, var(--card-bg), rgba(40, 40, 60, 0.8));
  }
  25% { 
    transform: scale(1.08) rotate(2deg);
    background: linear-gradient(135deg, var(--accent-green), #00b894);
  }
  50% { 
    transform: scale(1.05) rotate(-1deg);
    background: linear-gradient(135deg, #00b894, var(--accent-green));
  }
  75% { 
    transform: scale(1.08) rotate(1deg);
    background: linear-gradient(135deg, var(--accent-green), #00b894);
  }
}

@keyframes litersPulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.6);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 0 0 20px rgba(0, 212, 170, 0);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(0, 212, 170, 0);
  }
}

@keyframes ripple {
  0% {
    transform: scale(1);
    opacity: 0.3;
  }
  100% {
    transform: scale(1.2);
    opacity: 0;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.meter-circle .label {
  font-size: 1.1rem;
  opacity: 0.8;
  margin-bottom: 0.8rem;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.meter-circle .reading {
  font-size: 3.5rem;
  font-weight: 800;
  font-family: 'Courier New', monospace;
  margin: 0.8rem 0;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  background: linear-gradient(135deg, #fff, var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  transition: all 0.3s ease;
}

.meter-circle.liters-active .reading {
  background: linear-gradient(135deg, #fff, var(--accent-green));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: textGlow 1s ease-in-out infinite alternate;
}

@keyframes textGlow {
  from { 
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); 
  }
  to { 
    text-shadow: 0 0 20px rgba(0, 212, 170, 0.6); 
  }
}

.meter-circle .unit {
  font-size: 1rem;
  opacity: 0.7;
  font-weight: 500;
  letter-spacing: 1px;
  color: var(--text-secondary);
}

/* Water Droplet Animation */
.water-droplets {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.droplet {
  position: absolute;
  width: 6px;
  height: 6px;
  background: rgba(0, 212, 170, 0.6);
  border-radius: 50%;
  animation: fall linear infinite;
  box-shadow: 0 0 10px rgba(0, 212, 170, 0.8);
}

@keyframes fall {
  to { 
    transform: translateY(280px) rotate(360deg);
    opacity: 0;
  }
}

/* Glossy Cards */
.card {
  background: var(--card-bg);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2.5rem;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  border: 1px solid var(--card-border);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
  transition: left 0.6s;
}

.card:hover::before {
  left: 100%;
}

.card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 
    0 15px 40px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 0 0 1px rgba(255, 255, 255, 0.1);
}

.card h2 {
  margin-bottom: 1.5rem;
  font-size: 1.6rem;
  font-weight: 600;
  background: linear-gradient(135deg, #fff, var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card p {
  margin: 1rem 0;
  font-size: 1.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card strong {
  color: var(--text-secondary);
}

.card span {
  font-weight: 600;
  background: linear-gradient(135deg, #fff, var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#litersCard {
  background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 212, 170, 0.05));
  border: 1px solid rgba(0, 212, 170, 0.2);
}

#litersCard:hover {
  background: linear-gradient(135deg, rgba(0, 212, 170, 0.15), rgba(0, 212, 170, 0.08));
}

#billCard {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(56, 189, 248, 0.05));
  border: 1px solid rgba(56, 189, 248, 0.2);
}

#billCard:hover {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.15), rgba(56, 189, 248, 0.08));
}

/* Switch Container */
.switch-container {
  background: var(--card-bg);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.05),
    0 0 0 1px rgba(255, 255, 255, 0.05);
  border: 1px solid var(--card-border);
  transition: all 0.4s ease;
}

.switch-container:hover {
  transform: translateY(-5px);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.1),
    0 0 0 1px rgba(255, 255, 255, 0.1);
}

.switch-container p {
  font-size: 1.3rem;
  font-weight: 600;
  background: linear-gradient(135deg, #fff, var(--text-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Enhanced Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 90px;
  height: 45px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #2a2a3a, #1a1a2a);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border-radius: 45px;
  box-shadow: 
    inset 0 2px 5px rgba(0, 0, 0, 0.3),
    0 4px 15px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.slider:before {
  position: absolute;
  content: "";
  height: 37px;
  width: 37px;
  left: 4px;
  bottom: 4px;
  background: linear-gradient(135deg, #fff, #a0a0c0);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border-radius: 50%;
  box-shadow: 
    0 3px 8px rgba(0, 0, 0, 0.3),
    inset 0 -2px 3px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
  background: linear-gradient(135deg, var(--accent-green), #00b894);
  box-shadow: 
    inset 0 2px 5px rgba(0, 0, 0, 0.3),
    0 4px 20px rgba(0, 212, 170, 0.4);
}

input:checked + .slider:before {
  transform: translateX(45px);
  box-shadow: 
    0 3px 10px rgba(0, 0, 0, 0.4),
    inset 0 -2px 3px rgba(0, 0, 0, 0.2);
}

/* Alert Box */
#alertBox {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--accent-red), #ff4757);
  color: white;
  padding: 1.2rem 2.5rem;
  border-radius: 15px;
  box-shadow: 
    0 8px 25px rgba(255, 107, 107, 0.4),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  z-index: 1000;
  display: none;
  animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 600;
}

@keyframes slideDown {
  from { 
    transform: translateX(-50%) translateY(-30px); 
    opacity: 0; 
  }
  to { 
    transform: translateX(-50%) translateY(0); 
    opacity: 1; 
  }
}

/* Notification Popup */
.notif-popup {
  position: fixed; /* Use fixed so it stays centered on screen */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%); /* Center horizontally and vertically */
  background: var(--card-bg);
  backdrop-filter: blur(30px);
  border-radius: 15px;
  box-shadow: 
    0 15px 35px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  min-width: 300px;
  max-height: 400px;
  overflow-y: auto;
  display: none; /* Hidden by default */
  z-index: 1000;
  border: 1px solid var(--card-border);
  padding: 0;
  margin: 0;
}

/* List styles */
.notif-popup ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.notif-popup li {
  padding: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s ease;
  color: var(--text-primary);
}

.notif-popup li:hover {
  background: rgba(255, 255, 255, 0.05);
}

.notif-popup li:last-child {
  border-bottom: none;
}

/* Button inside popup */
.notif-popup button {
  background: var(--accent-red);
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 0.8rem;
  margin-left: auto;
  transition: all 0.3s ease;
}

.notif-popup button:hover {
  transform: scale(1.1);
}


/* Dark Glossy Chat Popup */
.chat-popup {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 380px;
  height: 600px;
  background: var(--card-bg);
  backdrop-filter: blur(30px);
  border-radius: 20px;
  box-shadow: 
    0 20px 50px rgba(0, 0, 0, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  display: none;
  flex-direction: column;
  z-index: 1000;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  border: 1px solid var(--card-border);
}

/* Chat Header */
.chat-header {
  background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
  color: white;
  padding: 1.2rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
  position: relative;
}

.chat-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: rgba(255, 255, 255, 0.2);
}

.chat-header span {
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.chat-header span::before {
  content: 'ðŸ’¬';
  font-size: 1.2rem;
}

.close-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Chat Messages Area */
.chat-messages {
  flex: 1;
  padding: 1.5rem;
  overflow-y: auto;
  background: rgba(20, 20, 35, 0.6);
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

/* Custom Scrollbar for Chat */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--accent-purple);
  border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #7c3aed;
}

/* Message Bubbles */
.chat-messages div {
  margin: 0.2rem 0;
  padding: 0.8rem 1.2rem;
  border-radius: 20px;
  max-width: 75%;
  word-wrap: break-word;
  position: relative;
  animation: messageSlide 0.3s ease-out;
  line-height: 1.4;
  font-size: 0.95rem;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Sent Messages (User) */
.chat-messages .sent {
  background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 6px;
  align-self: flex-end;
  box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
}

.chat-messages .sent::before {
  content: '';
  position: absolute;
  bottom: 0;
  right: -8px;
  width: 0;
  height: 0;
  border-left: 8px solid var(--accent-purple);
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

/* Received Messages (Admin/Employee) */
.chat-messages .received {
  background: rgba(40, 40, 60, 0.8);
  color: var(--text-primary);
  margin-right: auto;
  border-bottom-left-radius: 6px;
  align-self: flex-start;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-messages .received::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: -8px;
  width: 0;
  height: 0;
  border-right: 8px solid rgba(40, 40, 60, 0.8);
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

/* Message Metadata (Time) */
.message-time {
  display: block;
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 0.3rem;
  text-align: right;
}

.chat-messages .received .message-time {
  text-align: left;
  color: var(--text-secondary);
}

/* Chat Input Form */
.chat-form {
  display: flex;
  padding: 1.2rem 1.5rem;
  background: rgba(30, 30, 46, 0.8);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  gap: 0.8rem;
  align-items: center;
}

.chat-form input {
  flex: 1;
  padding: 0.9rem 1.2rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 25px;
  outline: none;
  font-size: 0.95rem;
  background: rgba(20, 20, 35, 0.6);
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.chat-form input:focus {
  border-color: var(--accent-purple);
  background: rgba(25, 25, 40, 0.8);
  box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
}

.chat-form input::placeholder {
  color: var(--text-secondary);
}

.chat-form button {
  background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
}

.chat-form button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.6);
}

.chat-form button:active {
  transform: scale(0.95);
}

.chat-form button::before {
  content: 'âž¤';
  font-size: 1rem;
  font-weight: bold;
}

/* Responsive Design */
@media (max-width: 768px) {
  .top-bar {
    padding: 1rem;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    padding: 1.5rem;
    gap: 1.5rem;
  }
  
  .meter-circle {
    width: 240px;
    height: 240px;
  }
  
  .meter-circle .reading {
    font-size: 3rem;
  }
  
  #welcomeMessage {
    font-size: 2.2rem;
    margin: 2rem 0;
  }
  
  .card {
    padding: 2rem;
  }
  
  .chat-popup {
    width: calc(100vw - 40px);
    height: 70vh;
    bottom: 10px;
    right: 10px;
    left: 10px;
  }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #7c3aed, #0ea5e9);
}

/* Floating Particles Background */
.particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}

.particle {
  position: absolute;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 50%;
  animation: float 20s infinite linear;
}

@keyframes float {
  0% {
    transform: translateY(100vh) rotate(0deg);
  }
  100% {
    transform: translateY(-100vh) rotate(360deg);
  }
}
   </style>
</head>
<body>

  <!-- Top Bar -->
  <div class="top-bar">
    <div style="position: relative;">
      <button class="notif-button" id="notifBtn">
        Notifications
        <span class="notif-count" id="notifCount">0</span>
      </button>
      <div class="notif-popup" id="notifPopup">
        <ul id="notifList"></ul>
      </div>
    </div>
   <a class="logout-button" href="viewer.html">Bill rates</a>
   <a class="logout-button" id="messagesBtn">Messages</a>
   <a href="analytics.html" class="logout-button" id="analyticsBtn">Analytics</a>
   <button class="logout-button" id="logoutBtn">Logout</button>
  </div>

  <!-- Welcome Message -->
  <h1 id="welcomeMessage">Welcome, Residence</h1>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- Water Meter -->
    <div class="meter-circle">
      <div class="label">Aquatrack</div>
      <div class="reading" id="counterDisplay">00000</div>
      <div class="unit">Cubic meter</div>
    </div>

    <!-- Liters Display -->
    <div id="litersCard" class="card">
      <h2 style="color:#22c55e;">Liters Reading</h2>
      <p><strong>Current:</strong> <span id="litersReading">0.000</span> L</p>
    </div>

    <!-- Bill Summary -->
    <div id="billCard" class="card">
      <h2 style="color:#38bdf8;">Water Bill Summary</h2>
      <p><strong>Consumption:</strong> <span id="billConsumption">0</span></p>
      <p><strong>Total Bill:</strong> <span id="billAmount">0.00</span></p>
    </div>

    <!-- Switch -->
    <div class="switch-container">
      <p id="switchStatus">Switch Status: Loading...</p>
      <label class="toggle-switch">
        <input type="checkbox" id="switchInput" />
        <span class="slider"></span>
      </label>
    </div>

  </div>

  <!-- Alert Box -->
  <div id="alertBox"></div>

  <!-- Chat Popup -->
  <div id="chatPopup" class="chat-popup">
    <div class="chat-header">
      <span>AquaTrack Concerns</span>
      <button id="closeChat" class="close-btn">Ã—</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <form id="chatForm" class="chat-form">
      <input type="text" id="chatInput" placeholder="Type a message..." required />
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDXNrUVM1VBaXOg2ZmkIFE9BKxexxBmpIs",
      authDomain: "waterbase-b1393.firebaseapp.com",
      databaseURL: "https://waterbase-b1393-default-rtdb.asia-southeast1.firebasedatabase.app/",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Paths and Elements
    const sensorPath = localStorage.getItem("sensorPath") || "/sensors1/water_timer_counter/value";
    const switchPath = localStorage.getItem("switchPath") || "/sensors1/control_switch/value";
    const alertPath  = localStorage.getItem("alertPath")  || "/sensors1/water_alerts";
    const username = localStorage.getItem("username") || "Residence";
    const currentUser = username;

    document.getElementById("welcomeMessage").innerText = `Welcome, ${username}`;

    const switchRef = db.ref(switchPath);
    const alertsRef = db.ref(alertPath);
    const switchStatus = document.getElementById("switchStatus");
    const switchInput = document.getElementById("switchInput");
    const alertBox = document.getElementById("alertBox");
    const notifList = document.getElementById("notifList");
    const notifPopup = document.getElementById("notifPopup");
    const notifCount = document.getElementById("notifCount");
    const notifBtn = document.getElementById("notifBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const meterCircle = document.querySelector('.meter-circle');

    let lastValue = null;
    let notifPopupOpen = false;
    let flowTimeout;
    const lastSeenTimestampKey = "lastSeenTimestamp";

    if (!localStorage.getItem(lastSeenTimestampKey)) {
      localStorage.setItem(lastSeenTimestampKey, Date.now());
      localStorage.setItem("unseenCount", 0);
    }

    let unseenCount = Number(localStorage.getItem("unseenCount")) || 0;
    notifCount.innerText = unseenCount;

    // Toggle notification popup
    notifBtn.addEventListener("click", () => {
      notifPopupOpen = !notifPopupOpen;
      notifPopup.style.display = notifPopupOpen ? "block" : "none";

      if (notifPopupOpen) {
        unseenCount = 0;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
        localStorage.setItem(lastSeenTimestampKey, Date.now());
      }
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    // Listen to switch changes
    switchRef.on("value", snap => {
      const val = snap.val();
      if (val === true || val === "true" || val === 1) {
        switchStatus.textContent = "Switch Status: ON";
        switchInput.checked = true;
      } else {
        switchStatus.textContent = "Switch Status: OFF";
        switchInput.checked = false;
      }
    });

    // Toggle switch
    switchInput.addEventListener("change", () => {
      switchRef.set(switchInput.checked);
    });

    // Water meter logic
    db.ref(sensorPath).on("value", snap => {
      const val = Number(snap.val()) || 0;
      document.getElementById("counterDisplay").innerText = String(val).padStart(5, "0");

      if (lastValue === null) {
        lastValue = val;
        return;
      }

      if (val > lastValue) {
        meterCircle.classList.add('flowing');
        clearTimeout(flowTimeout);
        flowTimeout = setTimeout(() => {
          meterCircle.classList.remove('flowing');
        }, 2000);

        const lastAlerted = Number(localStorage.getItem("lastAlertedPulses")) || 0;

        switchRef.get().then(snapSwitch => {
          const switchVal = snapSwitch.val();
          if ((!switchVal || switchVal === "false" || switchVal === 0) && val !== lastAlerted) {
            alertsRef.push({
              message: "Water leak detected",
              pulses: val,
              timestamp: Date.now(),
            });
            localStorage.setItem("lastAlertedPulses", val);
          }
        });
      }

      lastValue = val;
    });

    // Notifications UI
    alertsRef.on("value", snap => {
      const alerts = snap.val() || {};
      const alertEntries = Object.entries(alerts);
      alertEntries.sort((a, b) => b[1].timestamp - a[1].timestamp);
      notifList.innerHTML = "";
      const lastSeen = Number(localStorage.getItem(lastSeenTimestampKey)) || 0;
      let newUnseenCount = 0;

      alertEntries.forEach(([key, alert]) => {
        const li = document.createElement("li");
        li.textContent = `${alert.message} (${alert.pulses} pulses)`;
        const dismissBtn = document.createElement("button");
        dismissBtn.textContent = "Dismiss";
        dismissBtn.addEventListener("click", () => {
          alertsRef.child(key).remove();
        });
        li.appendChild(dismissBtn);
        notifList.appendChild(li);

        if (alert.timestamp > lastSeen) {
          newUnseenCount++;
        }
      });

      if (!notifPopupOpen && newUnseenCount > 0) {
        unseenCount = newUnseenCount;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
      }
    });

    // Show most recent alert
    alertsRef.limitToLast(1).on("child_added", snap => {
      const alert = snap.val();
      alertBox.textContent = alert.message + " (" + alert.pulses + " pulses)";
      alertBox.style.display = "block";
      setTimeout(() => { alertBox.style.display = "none"; }, 5000);
    });

    // ==== CHAT FEATURE ====
const chatPopup = document.getElementById("chatPopup");
const closeChat = document.getElementById("closeChat");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");
const chatMessages = document.getElementById("chatMessages");
const messagesBtn = document.getElementById("messagesBtn");

// Match Firebase JSON structure: "Residence_Employee"
const chatRoom = `${currentUser}_Employee`;
const chatRef = db.ref(`chats/${chatRoom}`);

// Open chat when Messages button clicked
messagesBtn.addEventListener("click", () => {
  chatPopup.style.display = "flex";
});

// Close chat
closeChat.addEventListener("click", () => {
  chatPopup.style.display = "none";
});

// Send message
chatForm.addEventListener("submit", e => {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatRef.push({ sender: currentUser, text: msg, timestamp: Date.now() });
  chatInput.value = "";
});

// Receive messages (Residence + Employee)
chatRef.on("child_added", snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = msg.sender === currentUser ? "sent" : "received";
  div.textContent = `${msg.sender}: ${msg.text}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

  // Notifications UI
    alertsRef.on("value", snap => {
      const alerts = snap.val() || {};
      const alertEntries = Object.entries(alerts);
      alertEntries.sort((a, b) => b[1].timestamp - a[1].timestamp);
      notifList.innerHTML = "";
      const lastSeen = Number(localStorage.getItem(lastSeenTimestampKey)) || 0;
      let newUnseenCount = 0;

      alertEntries.forEach(([key, alert]) => {
        const dateStr = new Date(alert.timestamp).toLocaleString();
        const li = document.createElement("li");
        li.textContent = `${alert.message} at ${dateStr}`;
        const delBtn = document.createElement("button");
        delBtn.textContent = "Ã—";
        delBtn.setAttribute("aria-label", "Delete alert");
        delBtn.addEventListener("click", () => {
          alertsRef.child(key).remove();
        });
        li.appendChild(delBtn);
        notifList.appendChild(li);
        if (alert.timestamp > lastSeen) newUnseenCount++;
      });

      if (!notifPopupOpen) {
        unseenCount = newUnseenCount;
        notifCount.innerText = unseenCount;
        localStorage.setItem("unseenCount", unseenCount);
      }
    });

    alertsRef.limitToLast(1).on("child_added", snap => {
      const alert = snap.val();
      if (!alert) return;

      alertBox.textContent = alert.message;
      alertBox.style.display = "block";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 4000);

      // Browser Notification
      async function fireSystemNotification(title, message) {
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            reg.showNotification(title, {
              body: message,
              icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
              vibrate: [100, 50, 100],
              tag: "water-alert",
              renotify: true,
            });
          }
        }
      }

      // Call the notification
      fireSystemNotification("Water Leak Detected", alert.message);
    });

    // Request notification permission
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Register Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("sw.js")
        .then(reg => {
          console.log("Service Worker registered", reg.scope);
        })
        .catch(err => {
          console.error("Service Worker registration failed", err);
        });
    }
    // === Billing System ===
  let currentRates = null;
  let currentConsumption = 0;

  // Load rates
  db.ref("residential_water_rates").on("value", snap => {
    currentRates = snap.val();
    updateBill();
  });

  // Load consumption (already cubic meters)
  db.ref(sensorPath).on("value", snap => {
    currentConsumption = Number(snap.val()) || 0;
    updateBill();
  });

  function calculateBill(consumption) {
    if (!currentRates) return 0;
    let bill = 0;

    if (consumption <= 5) {
      bill = parseFloat(currentRates.r0_5);
    } else if (consumption <= 10) {
      bill = parseFloat(currentRates.r0_5);
      for (let i = 6; i <= consumption; i++) {
        bill += parseFloat(currentRates["r" + i]);
      }
    } else {
      bill = parseFloat(currentRates.r0_5);
      for (let i = 6; i <= 10; i++) {
        bill += parseFloat(currentRates["r" + i]);
      }
      if (consumption > 10) {
        let extra = Math.min(consumption, 20) - 10;
        bill += extra * parseFloat(currentRates.r11_20);
      }
      if (consumption > 20) {
        let extra = Math.min(consumption, 30) - 20;
        bill += extra * parseFloat(currentRates.r21_30);
      }
      if (consumption > 30) {
        let extra = Math.min(consumption, 40) - 30;
        bill += extra * parseFloat(currentRates.r31_40);
      }
      if (consumption > 40) {
        let extra = Math.min(consumption, 50) - 40;
        bill += extra * parseFloat(currentRates.r41_50);
      }
      if (consumption > 50) {
        let extra = consumption - 50;
        bill += extra * parseFloat(currentRates.r51_up);
      }
    }
    return bill;
  }

  function updateBill() {
    if (!currentRates) return;
    const bill = calculateBill(currentConsumption);
    document.getElementById("billConsumption").textContent = currentConsumption + " mÂ³";
    document.getElementById("billAmount").textContent = "â‚±" + bill.toFixed(2);
  }
      
      
// System Notification Utility
async function fireSystemNotification(title, message) {
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      reg.showNotification(title, {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
        vibrate: [100, 50, 100],
        tag: "chat-message",
        renotify: true,
      });
    }
  }
}

      chatRef.on("child_added", snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = msg.sender === currentUser ? "sent" : "received";
  div.textContent = `${msg.sender}: ${msg.text}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // Show browser notification if message is from someone else
  if (msg.sender !== currentUser) {
    fireSystemNotification("New Message", `${msg.sender}: ${msg.text}`);
  }
});
 
      
      // Request notification permission
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Register service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("sw.js")
    .then(reg => {
      console.log("Service Worker registered", reg.scope);
    })
    .catch(err => {
      console.error("Service Worker registration failed", err);
    });
}
 
    
      
      // Liters path
const litersPath = sensorPath.replace("water_timer_counter/value", "water_timer_liters/value");
const litersRef = db.ref(litersPath);

// Listen for liters updates
litersRef.on("value", snap => {
  const liters = Number(snap.val()) || 0;
  document.getElementById("litersReading").textContent = liters.toFixed(3);
});
      
      // === MONTHLY DATA SAVE SYSTEM ===
  const monthlyRef = db.ref(`monthly_usage/${currentUser}`);

  // Convert consumption to liters (if your currentConsumption is in cubic meters)
  function saveMonthlyData() {
    const now = new Date();
    const month = now.toLocaleString("default", { month: "long" }); // e.g. October
    const year = now.getFullYear();
    const litersUsed = currentConsumption * 1000; // 1 cubic meter = 1000 liters

    const monthKey = `${year}_${month}`; // e.g. 2025_October

    // Save/update Firebase record for this month
    monthlyRef.child(monthKey).set({
      month: month,
      year: year,
      consumption_m3: currentConsumption,
      consumption_liters: litersUsed,
      updatedAt: Date.now()
    });
  }

  // Whenever bill updates (so reading changes), also save data
  db.ref(sensorPath).on("value", snap => {
    currentConsumption = Number(snap.val()) || 0;
    updateBill();
    saveMonthlyData(); // Save automatically
  });

  // Add this to your existing JavaScript, after the litersRef listener:

// Enhanced liters detection with animations
let lastLitersValue = 0;
let litersAnimationTimeout;

litersRef.on("value", snap => {
  const liters = Number(snap.val()) || 0;
  const litersElement = document.getElementById("litersReading");
  
  // Update display with animation
  litersElement.textContent = liters.toFixed(3);
  
  // Add pulse animation to liters value
  litersElement.style.animation = 'none';
  setTimeout(() => {
    litersElement.style.animation = 'textPulse 0.6s ease';
  }, 10);
  
  // Activate meter circle animation when liters are detected
  if (liters > 0 && liters !== lastLitersValue) {
    const meterCircle = document.querySelector('.meter-circle');
    
    // Add liters-active class for green color and animations
    meterCircle.classList.add('liters-active');
    
    // Create water droplets effect
    createWaterDroplets();
    
    // Remove the class after animation completes
    clearTimeout(litersAnimationTimeout);
    litersAnimationTimeout = setTimeout(() => {
      meterCircle.classList.remove('liters-active');
    }, 2000);
  }
  
  lastLitersValue = liters;
});

// Function to create water droplet animations
function createWaterDroplets() {
  const meterCircle = document.querySelector('.meter-circle');
  const dropletsContainer = document.createElement('div');
  dropletsContainer.className = 'water-droplets';
  
  // Create multiple droplets
  for (let i = 0; i < 8; i++) {
    const droplet = document.createElement('div');
    droplet.className = 'droplet';
    droplet.style.left = `${Math.random() * 100}%`;
    droplet.style.animationDelay = `${Math.random() * 1.5}s`;
    droplet.style.animationDuration = `${1 + Math.random() * 2}s`;
    dropletsContainer.appendChild(droplet);
  }
  
  meterCircle.appendChild(dropletsContainer);
  
  // Remove droplets after animation
  setTimeout(() => {
    if (dropletsContainer.parentNode) {
      dropletsContainer.remove();
    }
  }, 3000);
}

// Add this CSS for text pulse animation
const style = document.createElement('style');
style.textContent = `
  @keyframes textPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); color: #55efc4; }
  }
`;
document.head.appendChild(style);

// Open chat when Messages button clicked
messagesBtn.addEventListener("click", () => {
  chatPopup.style.display = "flex";
  chatInput.focus();
  // Scroll to bottom when opening
  setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
});
      
      
// Format timestamp function
function formatTime(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  // If less than 1 minute ago
  if (diff < 60000) {
    return 'Just now';
  }
  
  // If today
  if (date.toDateString() === now.toDateString()) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // If yesterday
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // Otherwise, show date and time
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Close chat when clicking outside
document.addEventListener('click', (e) => {
  if (chatPopup.style.display === 'flex' && 
      !chatPopup.contains(e.target) && 
      e.target !== messagesBtn) {
    chatPopup.style.display = 'none';
  }
});

  </script>
</body>
</html>
